// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Project {
  id           String    @id @default(cuid())
  title        String
  description  String    @db.Text
  readme       String?   @db.Text // Full README content in markdown
  technologies String    // Comma-separated list of technologies
  repoUrl      String?   // Optional for private repos
  demoUrl      String?

  // GitHub integration fields
  githubId     Int?      @unique
  source       String    @default("manual") // "manual" | "github"
  aiSummary    String?   @db.Text
  aiSummarizedAt DateTime?
  imageUrl     String?
  stars        Int?
  featured     Boolean   @default(false)

  // Top 3 and private repo support
  rank         Int?      // 1, 2, 3 for top 3 featured (null = not featured)
  isPrivate    Boolean   @default(false) // mark if it's a private repo

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([createdAt])
  @@index([featured])
  @@index([source])
  @@index([rank])
}

model Experience {
  id               String    @id @default(cuid())
  title            String
  description      String    @db.Text
  responsibilities String    @db.Text // Comma-separated list of responsibilities
  challenges       String    @db.Text // Comma-separated list of challenges
  technologies     String    // Comma-separated list of technologies

  // Enhanced fields
  company          String?
  startDate        DateTime?
  endDate          DateTime? // null = current position
  location         String?

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([createdAt])
  @@index([startDate])
}

model GitHubRepoCache {
  id          Int      @id
  name        String
  fullName    String
  description String?  @db.Text
  htmlUrl     String
  homepage    String?
  language    String?
  topics      String?  // Comma-separated
  stargazers  Int
  forksCount  Int
  updatedAt   DateTime
  cachedAt    DateTime @default(now())

  @@index([cachedAt])
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String?
  message   String   @db.Text
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([read])
  @@index([email])
}

model Skill {
  id       String @id @default(cuid())
  name     String
  category String // "frontend" | "backend" | "devops" | "tools" | "other"
  level    Int    // 1-5 proficiency
  iconUrl  String?
  order    Int    @default(0)

  @@index([category])
  @@index([order])
}

model SiteConfig {
  id          String @id @default("main")
  name        String @default("Portfolio")
  title       String @default("Full Stack Developer")
  bio         String? @db.Text
  avatarUrl   String?
  githubUrl   String?
  linkedinUrl String?
  twitterUrl  String?
  email       String?
  location    String?

  // WakaTime Configuration (JSON)
  wakatimeConfig String? @db.Text
}

// ==========================================
// Authentication Models
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  isActive      Boolean   @default(true)

  // Relations
  sessions      Session[]
  verificationCodes VerificationCode[]
  loginHistory  LoginHistory[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Session {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  token         String    @unique
  ipAddress     String?
  userAgent     String?
  isValid       Boolean   @default(true)

  expiresAt     DateTime
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([token])
  @@index([isValid])
}

model VerificationCode {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  code          String
  type          String    @default("login") // "login" | "password_reset"
  isUsed        Boolean   @default(false)

  expiresAt     DateTime
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([code])
}

model LoginHistory {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  ipAddress     String?
  userAgent     String?
  location      String?
  success       Boolean   @default(true)
  failReason    String?

  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([createdAt])
}

// ==========================================
// Site Analytics
// ==========================================

model SiteStats {
  id            String    @id @default("main")
  totalVisits   Int       @default(0)
  uniqueVisits  Int       @default(0)
  updatedAt     DateTime  @updatedAt
}

model PageView {
  id            String    @id @default(cuid())
  visitorId     String    // Anonymous visitor ID (stored in cookie)
  page          String    @default("/")
  referrer      String?
  userAgent     String?
  ipAddress     String?
  country       String?
  city          String?
  device        String?   // "desktop" | "mobile" | "tablet"
  browser       String?
  os            String?
  createdAt     DateTime  @default(now())

  @@index([visitorId])
  @@index([createdAt])
  @@index([page])
  @@index([ipAddress])
}

// ==========================================
// Job Search & Application Tracker
// ==========================================

model SavedJob {
  id            String    @id @default(cuid())
  externalId    String    @unique
  source        String    // "remoteok" | "remotive"
  title         String
  company       String
  companyLogo   String?
  description   String    @db.Text
  url           String
  location      String?
  jobType       String?
  salary        String?
  tags          String?   // Comma-separated
  postedAt      DateTime?
  notes         String?   @db.Text
  savedAt       DateTime  @default(now())

  application   JobApplication?

  @@index([source])
  @@index([savedAt])
}

model JobApplication {
  id            String    @id @default(cuid())
  savedJobId    String?   @unique
  savedJob      SavedJob? @relation(fields: [savedJobId], references: [id], onDelete: SetNull)

  title         String
  company       String
  url           String?
  location      String?
  salary        String?
  status        String    @default("saved") // "saved" | "applied" | "interview" | "offer" | "rejected"
  appliedAt     DateTime?
  notes         String?   @db.Text
  timeline      String?   @db.Text  // JSON array of status changes
  nextStep      String?
  nextStepDate  DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([appliedAt])
}

// ==========================================
// Job Search History
// ==========================================

model JobSearchHistory {
  id          String   @id @default(cuid())
  keyword     String
  countries   String   // comma-separated
  sources     String   // comma-separated
  filters     String?  @db.Text // JSON
  resultCount Int
  searchedAt  DateTime @default(now())

  @@index([searchedAt])
}

// ==========================================
// Job Alerts
// ==========================================

model JobAlert {
  id          String   @id @default(cuid())
  name        String
  keyword     String
  countries   String
  sources     String
  filters     String?  @db.Text
  isActive    Boolean  @default(true)
  lastRun     DateTime?
  createdAt   DateTime @default(now())

  matches     JobAlertMatch[]

  @@index([isActive])
}

model JobAlertMatch {
  id         String   @id @default(cuid())
  alertId    String
  alert      JobAlert @relation(fields: [alertId], references: [id], onDelete: Cascade)
  jobId      String   // externalId da vaga
  jobTitle   String
  company    String
  matchedAt  DateTime @default(now())
  notified   Boolean  @default(false)

  @@unique([alertId, jobId])
  @@index([alertId])
  @@index([matchedAt])
}

// ==========================================
// WakaTime Cache
// ==========================================

model WakaTimeYearCache {
  id                String   @id // Format: "year_2024"
  year              Int      @unique
  totalSeconds      Int
  totalHours        String
  dailyAverage      String
  bestDayDate       String?
  bestDaySeconds    Int?
  bestDayText       String?
  languages         String   @db.Text // JSON array
  editors           String   @db.Text // JSON array
  operatingSystems  String   @db.Text // JSON array
  projects          String   @db.Text // JSON array
  categories        String   @db.Text // JSON array
  rangeStart        String
  rangeEnd          String
  rangeText         String
  cachedAt          DateTime @default(now())

  @@index([year])
}

// ==========================================
// AI Usage Tracking
// ==========================================

model AIUsageLog {
  id            String   @id @default(cuid())
  feature       String   // 'job-extraction', 'project-summary', etc.
  model         String   // 'meta-llama/Llama-3.3-70B-Instruct-Turbo'
  inputTokens   Int
  outputTokens  Int
  totalTokens   Int
  cost          Float    // Cost in USD
  latencyMs     Int      // Response time
  success       Boolean  @default(true)
  error         String?  @db.Text // Error message if failed
  metadata      Json?    // Extra data (ex: jobCount, projectId)
  createdAt     DateTime @default(now())

  @@index([feature])
  @@index([createdAt])
  @@index([success])
}

model AIUsageQuota {
  id            String   @id @default("main")
  dailyLimit    Float    @default(5.0)   // Daily limit in USD
  monthlyLimit  Float    @default(50.0)  // Monthly limit in USD
  alertAt       Float    @default(0.8)   // Alert at 80% of limit
  updatedAt     DateTime @updatedAt
}

// ==========================================
// Rate Limiting (Persistent)
// ==========================================

model RateLimitEntry {
  id           String    @id @default(cuid())
  key          String    @unique // IP + action identifier
  count        Int       @default(1)
  windowStart  DateTime
  blockedUntil DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([windowStart])
  @@index([blockedUntil])
}

// ==========================================
// Security Audit Logging
// ==========================================

model AuditLog {
  id        String   @id @default(cuid())
  action    String   // 'login', 'project.create', 'settings.update', etc.
  userId    String?  // null for anonymous actions
  ip        String
  userAgent String?  @db.Text
  resource  String?  // Resource affected (e.g., 'project:abc123')
  details   Json?    // Additional context
  success   Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([action])
  @@index([userId])
  @@index([createdAt])
}

// ==========================================
// System Logs (Application Logs)
// ==========================================

model SystemLog {
  id        String   @id @default(cuid())
  level     String   // 'error', 'warn', 'info', 'debug'
  source    String   // 'geekhunter', 'vagascombr', 'python-scraper', 'api', etc.
  message   String   @db.Text
  details   Json?    // Stack trace, request info, etc.
  createdAt DateTime @default(now())

  @@index([level])
  @@index([source])
  @@index([createdAt])
}
